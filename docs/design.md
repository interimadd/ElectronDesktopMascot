# Electronデスクトップマスコットアプリ 設計書

## 要件定義書

### 概要
Electronを使用したデスクトップマスコットアプリケーションを開発する。猫のキャラクターをデスクトップに表示し、ユーザーとテキストベースの会話ができる機能を提供する。

### 機能要件
1. **デスクトップマスコット表示**
   - 猫のキャラクターをデスクトップに表示する
   - 背景は透過させる
   - 指定されたCSS（https://codepen.io/carolineartz/pen/qBOEzQa）を使用してキャラクターを表示

2. **チャット機能**
   - ユーザーはキャラクターとテキストベースの会話ができる
   - 会話のバックエンドにはChatGPT APIを使用
   - キャラクターの上に吹き出しを表示してチャットを可視化

3. **アプリケーション動作**
   - Electronを使用してデスクトップアプリとして動作
   - 常駐アプリケーションとして動作し、タスクトレイからアクセス可能

### 非機能要件
1. **技術スタック**
   - プログラミング言語: TypeScript
   - フレームワーク: Electron
   - UI: HTML, CSS, JavaScript
   - バックエンド: ChatGPT API

2. **パフォーマンス**
   - 軽量で、システムリソースの消費を最小限に抑える
   - 応答性の高いUI

3. **セキュリティ**
   - ChatGPT APIキーの安全な管理

## 設計書

### 概略設計

#### アプリケーション構成
- **メインプロセス**: Electronのメインプロセスでアプリケーションのライフサイクルを管理
- **レンダラープロセス**: UIの表示と操作を担当
- **IPC通信**: メインプロセスとレンダラープロセス間の通信

#### 画面構成
1. **マスコット表示画面**
   - 透過背景の猫キャラクター
   - チャット用の吹き出し
   - テキスト入力フィールド

2. **設定画面**
   - ChatGPT APIキー設定
   - マスコットの表示設定（サイズ、位置など）

### 機能設計

#### マスコット表示機能
- 透過ウィンドウの作成
- CSSアニメーションを使用した猫キャラクターの表示
- ドラッグ可能なウィンドウ実装

#### チャット機能
- テキスト入力フィールドの実装
- ChatGPT APIとの通信処理
- 吹き出し表示の実装

#### システムトレイ機能
- システムトレイアイコンの表示
- コンテキストメニューの実装（設定画面表示、終了など）

### クラス構成

#### メインプロセス
- **App**: アプリケーション全体の管理
  - アプリケーションのライフサイクル管理
  - ウィンドウ管理
  - IPC通信の設定

- **ConfigManager**: 設定の管理
  - 設定の読み込み・保存
  - APIキーの管理

- **TrayManager**: システムトレイの管理
  - トレイアイコンの表示
  - コンテキストメニューの管理

#### レンダラープロセス
- **MascotRenderer**: マスコットの表示管理
  - CSSアニメーションの制御
  - マスコットの位置管理

- **ChatManager**: チャット機能の管理
  - テキスト入力の処理
  - ChatGPT APIとの通信
  - 会話履歴の管理

- **BubbleRenderer**: 吹き出しの表示管理
  - 吹き出しのレンダリング
  - テキストの表示・アニメーション

### データフロー
1. ユーザーがテキストを入力
2. ChatManagerがテキストを受け取り、ChatGPT APIにリクエスト
3. APIからのレスポンスをBubbleRendererに渡す
4. BubbleRendererが吹き出しを表示

### ファイル構成
```
/
├── docs/                  # ドキュメント
│   └── design.md          # 設計書
├── src/                   # ソースコード
│   ├── main/              # メインプロセス
│   │   ├── app.ts         # アプリケーションのエントリーポイント
│   │   ├── config.ts      # 設定管理
│   │   └── windows/       # ウィンドウ管理
│   │       ├── bubble-window.ts    # 吹き出しウィンドウ
│   │       ├── mascot-window.ts    # マスコットウィンドウ
│   │       └── settings-window.ts  # 設定ウィンドウ
│   ├── renderer/          # レンダラープロセス
│   │   ├── bubble.html    # 吹き出しのHTML
│   │   ├── bubble.ts      # 吹き出し表示管理
│   │   ├── mascot.html    # マスコットのHTML
│   │   ├── mascot.ts      # マスコット表示管理
│   │   ├── settings.html  # 設定画面のHTML
│   │   ├── settings.ts    # 設定画面管理
│   │   └── types.d.ts     # 型定義
│   ├── styles/            # スタイルシート
│   │   ├── bubble.css     # 吹き出しのスタイル
│   │   ├── mascot.css     # マスコットのスタイル
│   │   └── mascot/        # マスコット画像
│   │       ├── bongo1.png # マスコット画像1
│   │       └── bongo2.png # マスコット画像2
│   ├── utils/             # ユーティリティ
│   │   ├── api.ts         # API通信
│   │   └── logger.ts      # ロギング
│   ├── index.ts           # エントリーポイント
│   └── preload.ts         # プリロードスクリプト
├── tests/                 # テストコード
│   ├── main/              # メインプロセスのテスト
│   │   └── config.test.ts # 設定管理のテスト
│   ├── renderer/          # レンダラープロセスのテスト
│   └── utils/             # ユーティリティのテスト
│       ├── api.test.ts    # API通信のテスト
│       └── logger.test.ts # ロギングのテスト
├── .clinerules            # Clineルール設定
├── .gitignore             # Git除外設定
├── jest.config.js         # Jestテスト設定
├── package-lock.json      # パッケージロック
├── package.json           # パッケージ設定
└── tsconfig.json          # TypeScript設定
```

### ディレクトリ構造の役割

#### メインプロセス (`src/main`)

メインプロセスはElectronアプリケーションの中核となるプロセスで、以下の役割を担っています：

1. **アプリケーションのライフサイクル管理**
   - アプリの起動、終了、バックグラウンド動作などを制御
   - `src/main/app.ts`がこの役割を担当

2. **ウィンドウ管理**
   - 各種ウィンドウ（マスコット、吹き出し、設定画面）の作成、表示、非表示、位置制御
   - `src/main/windows/`ディレクトリ内のファイルがこれらを管理

3. **システムレベルの機能**
   - 設定の保存・読み込み（`src/main/config.ts`）
   - APIキーの管理
   - 外部APIとの通信の仲介

4. **IPC通信の管理**
   - レンダラープロセスからのリクエストを受け付け、処理を実行
   - `ipcMain`を使用して通信チャネルを設定

#### レンダラープロセス (`src/renderer`)

レンダラープロセスはユーザーインターフェースを担当するプロセスで、以下の役割を担っています：

1. **UI表示と操作**
   - HTML、CSS、JavaScriptを使用してユーザーインターフェースを構築
   - マスコットの表示とアニメーション（`src/renderer/mascot.ts`）
   - 吹き出しの表示とチャット機能（`src/renderer/bubble.ts`）
   - 設定画面の表示と操作（`src/renderer/settings.ts`）

2. **ユーザー操作の処理**
   - クリック、ドラッグなどのユーザー操作を検知して処理
   - 例：`WindowDragController`クラスによるマスコットのドラッグ移動

3. **メインプロセスとの通信**
   - `window.electronAPI`（`preload.ts`で定義）を通じてメインプロセスと通信
   - ユーザー操作をメインプロセスに伝達
   - メインプロセスからの情報を受け取ってUIに反映

#### プロセス間通信 (`src/preload.ts`)

`preload.ts`は両プロセスの橋渡し役として機能します：

1. **安全なAPI公開**
   - `contextBridge.exposeInMainWorld`を使用して、レンダラープロセスから安全にメインプロセスの機能にアクセスできるAPIを公開
   - セキュリティを確保しながら必要な機能だけを公開

2. **IPC通信の実装**
   - `ipcRenderer.invoke`を使用してメインプロセスの関数を呼び出し
   - 例：メッセージ送信、設定の保存・取得、ウィンドウ位置の制御など

### 技術的な検討事項
1. **ウィンドウの透過処理**
   - Electronの`transparent: true`オプションを使用
   - `frame: false`でフレームレスウィンドウを実現

2. **ChatGPT API連携**
   - OpenAI APIクライアントライブラリを使用
   - APIキーの安全な保存方法（electron-storeなどを使用）

3. **CSSアニメーション**
   - 提供されたCSSを適応し、Electron環境で動作するように調整
   - アニメーションのパフォーマンス最適化

4. **ドラッグ可能なウィンドウ**
   - カスタムドラッグ処理の実装
   - ウィンドウ位置の保存と復元